# EyeTracker.py 改良作業ログ

**日付**: 2025-08-10  
**作業内容**: SimpleWebcam.pyの機能を統合したEyeTracker.pyの改良

## 作業概要

`SimpleWebcam.py`の機能を基にして、`EyeTracker.py`を大幅に改良し、より使いやすい目のトラッキングシステムを作成しました。

## 主な改良点

### 1. ウィンドウサイズの拡大
- デフォルト解像度を1280x720から1920x1080に変更
- より詳細な目のトラッキング表示が可能

### 2. キー操作の改善
- ESCキーでアプリケーション終了（従来のqキーから変更）
- より直感的な操作感

### 3. スクリーンショット機能の追加
- `[c]`キーでスクリーンショット保存
- タイムスタンプ付きファイル名で自動保存
- 保存先: `docs/Webcam/`ディレクトリ

### 4. 動画保存機能の統合
- `[s]`キーで録画開始
- `[e]`キーで録画終了
- 録画時間の表示
- MP4形式で保存

### 5. 保存ディレクトリの整理
- `docs/Webcam/`ディレクトリに統一
- スクリーンショットと動画を同じ場所に保存
- 自動ディレクトリ作成機能

## 技術仕様

### ファイル保存形式
- スクリーンショット: JPG形式
- 動画: MP4形式（H.264コーデック）
- フレームレート: 20fps

### ファイル命名規則
- スクリーンショット: `screenshot_YYYYMMDD_HHMMSS.jpg`
- 動画: `video_YYYYMMDD_HHMMSS.mp4`

### 操作キー
- `[s]`: 録画開始
- `[e]`: 録画終了
- `[c]`: スクリーンショット保存
- `[ESC]`: アプリケーション終了

## 実装詳細

### 新規追加クラスメソッド
1. `_save_screenshot()`: スクリーンショット保存処理
2. `_start_recording()`: 録画開始処理
3. `_stop_recording()`: 録画終了処理
4. `_draw_controls()`: 操作説明の描画

### 既存メソッドの改良
- `_run_mediapipe()`: 録画機能とスクリーンショット機能を統合
- `_run_opencv()`: 同様の機能を統合
- キーイベント処理の統一化

## 問題と解決方法

### 問題1: 録画中のフレーム保存
- **問題**: 録画中にフレームが正しく保存されない
- **解決**: 各フレーム処理の最初に録画チェックを追加

### 問題2: 保存ディレクトリの存在確認
- **問題**: 保存ディレクトリが存在しない場合のエラー
- **解決**: 初期化時に自動ディレクトリ作成を実装

### 問題3: キー操作の統一
- **問題**: MediaPipeとOpenCVで異なるキー処理
- **解決**: 共通のキー処理メソッドを実装

## 今後の展開

### 短期的な改善
1. 録画品質の調整オプション追加
2. 保存ファイルの圧縮設定
3. エラーハンドリングの強化

### 長期的な改善
1. 設定ファイルによるカスタマイズ
2. リアルタイム分析結果の保存
3. 複数カメラ対応
4. ネットワークストリーミング機能

## 動作確認

### テスト環境
- OS: Windows 10
- Python: 3.x
- OpenCV: 4.x
- MediaPipe: 0.x（オプション）

### 確認項目
- [x] カメラ起動
- [x] 目のトラッキング表示
- [x] スクリーンショット保存
- [x] 動画録画・保存
- [x] ESCキーでの終了
- [x] 高解像度表示

## 注意事項

1. MediaPipeがインストールされていない場合はOpenCVフォールバックを使用
2. 録画ファイルは大きくなる可能性があるため、十分なディスク容量を確保
3. カメラデバイスのインデックスは環境によって異なる場合がある

## 関連ファイル

- `Code/EyeTracker.py`: 改良されたメインファイル
- `Code/SimpleWebcam.py`: 機能統合のベースファイル
- `Code/docs/Webcam/`: 保存ファイルの格納ディレクトリ
